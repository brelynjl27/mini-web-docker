name: Docker CI/CD (ConstrucciÃ³n y Push)

on:
  push:
    branches: [ "main" ] # Se dispara al subir cambios a la rama principal
  workflow_dispatch: # Permite ejecutarlo manualmente desde GitHub

env:
  # Nombre completo de la imagen en Docker Hub (ej: brelyn27/mini-web)
  DOCKER_IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/mini-web 
  
jobs:
  build_and_push:
    runs-on: ubuntu-latest
    
    steps:
    - name: â¬‡ï¸ Checkout del cÃ³digo
      uses: actions/checkout@v4

    - name: âš™ï¸ Configurar Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ”’ Loguearse en Docker Hub
      uses: docker/login-action@v3
      with:
        # Usamos los secretos de GitHub para el login
        username: ${{ secrets.DOCKER_USERNAME }} 
        password: ${{ secrets.DOCKER_TOKEN }}    # Â¡AquÃ­ va el PAT!

    - name: ğŸ”– Obtener Tags y Labels para la Imagen
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.DOCKER_IMAGE_NAME }}
        tags: |
          type=raw,value=latest
          type=sha,format=short

    - name: ğŸ“¦ Construir y Subir la Imagen a Docker Hub
      uses: docker/build-push-action@v5
      with:
        context: . # Asume que el Dockerfile estÃ¡ en la raÃ­z
        push: true 
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
