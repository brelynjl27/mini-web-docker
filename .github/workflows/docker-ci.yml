name: Docker CI/CD (Construcci贸n y Push)

on:
  push:
    branches: [ "main" ] # Se dispara al subir c贸digo a la rama 'main'
  workflow_dispatch: # Permite ejecuci贸n manual

env:
  # Tu nombre de usuario (brelyn27) se inyecta desde el secreto
  DOCKER_IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/mini-web 
  
jobs:
  build_and_push:
    runs-on: ubuntu-latest
    
    steps:
    - name: 猬锔 Checkout del c贸digo
      uses: actions/checkout@v4

    - name: 锔 Configurar Docker Buildx
      # Necesario para construir im谩genes de manera eficiente
      uses: docker/setup-buildx-action@v3

    - name:  Loguearse en Docker Hub
      uses: docker/login-action@v3
      with:
        # Usa el nombre de usuario y el NUEVO PAT
        username: ${{ secrets.DOCKER_USERNAME }} 
        password: ${{ secrets.DOCKER_TOKEN }}

    - name:  Obtener Tags para la Imagen
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.DOCKER_IMAGE_NAME }}
        # Genera dos tags: 'latest' y un tag basado en el commit SHA corto
        tags: |
          type=raw,value=latest
          type=sha,format=short

    - name:  Construir y Subir la Imagen a Docker Hub
      uses: docker/build-push-action@v5
      with:
        context: . # Usa el Dockerfile en la carpeta ra铆z
        push: true # 隆Esto activa el despliegue a Docker Hub!
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
